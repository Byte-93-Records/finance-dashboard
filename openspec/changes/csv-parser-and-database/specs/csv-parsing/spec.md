# Delta for CSV Parsing

## ADDED Requirements

### Requirement: Parse CSV Files from PDF Extraction
The system SHALL parse CSV files generated by PDF extraction into validated data structures before database ingestion.

#### Scenario: Valid CSV parsing
- **GIVEN** a CSV file in `/data/csv/` with all required columns
- **WHEN** the CSV parser executes
- **THEN** all rows SHALL be parsed into `TransactionRow` Pydantic models
- **AND** all date fields SHALL be validated as YYYY-MM-DD format
- **AND** all amount fields SHALL be validated as Decimal with 2 decimal places
- **AND** all transaction_type fields SHALL be validated as "debit" or "credit"

#### Scenario: Invalid CSV schema
- **GIVEN** a CSV file missing required columns (transaction_date, description, amount, or transaction_type)
- **WHEN** the CSV parser executes
- **THEN** parsing SHALL fail with `ValidationError`
- **AND** error message SHALL list all missing columns
- **AND** the CSV SHALL NOT be processed further

#### Scenario: Invalid data types
- **GIVEN** a CSV file with invalid data (e.g., date "01/15/2024" instead of "2024-01-15")
- **WHEN** the CSV parser executes
- **THEN** parsing SHALL fail with `ValidationError`
- **AND** error message SHALL include row number, field name, invalid value, and expected format
- **AND** all validation errors SHALL be collected (not fail on first error)

### Requirement: Stream CSV Parsing for Memory Efficiency
The system SHALL parse CSV files row-by-row to handle large files without loading entire file into memory.

#### Scenario: Large CSV file parsing
- **GIVEN** a CSV file with 10,000+ transaction rows
- **WHEN** the CSV parser executes
- **THEN** parsing SHALL process rows incrementally (not load entire file)
- **AND** memory usage SHALL remain constant regardless of file size
- **AND** parsing SHALL complete without memory errors

### Requirement: Detailed Validation Error Messages
The system SHALL provide clear, actionable error messages for CSV validation failures.

#### Scenario: Validation error reporting
- **GIVEN** a CSV file with multiple validation errors (row 5: bad date, row 12: bad amount, row 18: bad transaction_type)
- **WHEN** the CSV parser executes
- **THEN** error message SHALL include:
  - CSV filename
  - Row number for each error
  - Field name for each error
  - Invalid value for each error
  - Expected format/type for each error
- **AND** all errors SHALL be reported together (not just first error)

#### Scenario: Example error message format
- **GIVEN** a CSV with validation errors
- **WHEN** validation fails
- **THEN** error message SHALL follow format:
  ```
  CSV Validation Failed: /data/csv/chase_statement_2024-01.csv
  Row 5: transaction_date - invalid date format "01/15/2024" (expected YYYY-MM-DD)
  Row 12: amount - invalid decimal "1,234.56" (remove commas)
  Row 18: transaction_type - invalid value "purchase" (expected debit or credit)
  ```

### Requirement: No Automatic Data Correction
The system SHALL NOT automatically correct invalid data in CSV files.

#### Scenario: Invalid date format
- **GIVEN** a CSV with date "01/15/2024" (MM/DD/YYYY format)
- **WHEN** the CSV parser executes
- **THEN** parsing SHALL fail with validation error
- **AND** the date SHALL NOT be automatically converted to "2024-01-15"
- **AND** user SHALL be required to fix source PDF or CSV manually

#### Scenario: Invalid amount format
- **GIVEN** a CSV with amount "1,234.56" (with comma separator)
- **WHEN** the CSV parser executes
- **THEN** parsing SHALL fail with validation error
- **AND** the comma SHALL NOT be automatically removed
- **AND** user SHALL be required to fix source PDF or CSV manually

### Requirement: Description Normalization for Hashing
The system SHALL normalize transaction descriptions before hash generation to improve deduplication accuracy.

#### Scenario: Description normalization
- **GIVEN** a transaction with description "  STARBUCKS #1234  " (leading/trailing whitespace)
- **WHEN** description normalization executes
- **THEN** normalized description SHALL be "starbucks #1234" (lowercase, whitespace stripped)
- **AND** normalization SHALL preserve numbers and special characters
- **AND** normalization SHALL be deterministic (same input always produces same output)

#### Scenario: Conservative normalization
- **GIVEN** two transactions with descriptions "STARBUCKS #1234" and "STARBUCKS #5678"
- **WHEN** description normalization executes
- **THEN** normalized descriptions SHALL be different ("starbucks #1234" vs "starbucks #5678")
- **AND** transactions SHALL NOT be treated as duplicates (store numbers preserved)

### Requirement: CSV Schema Validation
The system SHALL validate CSV files against required schema before processing.

#### Scenario: Required columns present
- **GIVEN** a CSV file with columns: transaction_date, description, amount, transaction_type
- **WHEN** schema validation executes
- **THEN** validation SHALL pass
- **AND** CSV SHALL be processed

#### Scenario: Optional columns present
- **GIVEN** a CSV file with optional columns: posting_date, balance
- **WHEN** schema validation executes
- **THEN** validation SHALL pass
- **AND** optional fields SHALL be parsed if present
- **AND** optional fields SHALL be NULL if absent

#### Scenario: Extra columns present
- **GIVEN** a CSV file with extra columns not in schema (e.g., "memo", "check_number")
- **WHEN** schema validation executes
- **THEN** validation SHALL pass
- **AND** extra columns SHALL be ignored
- **AND** only required and optional columns SHALL be parsed
